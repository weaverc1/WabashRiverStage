<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wabash River at Hutsonville Bridge - River Stage Monitor</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            box-sizing: border-box;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
            width: calc(100% - 40px);
            max-width: calc(100vw - 40px);
        }

        header {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 600;
        }

        header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .status-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            padding: 20px 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
        }

        .status-card {
            background: white;
            padding: 12px 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            text-align: center;
        }

        .status-card h3 {
            font-size: 0.75em;
            color: #666;
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .status-card .value {
            font-size: 3em;
            font-weight: bold;
            color: #2c3e50;
        }

        .status-card .unit {
            font-size: 1em;
            color: #999;
            margin-left: 5px;
        }

        .status-card.warning .value {
            color: #f39c12;
        }

        .status-card.danger .value {
            color: #e74c3c;
        }

        .chart-container {
            padding: 20px;
            box-sizing: border-box;
            max-width: 100%;
            overflow-x: hidden;
        }

        .chart-wrapper {
            width: 100%;
            max-width: 100%;
            overflow: hidden;
            box-sizing: border-box;
        }

        #riverChart {
            height: 600px;
        }

        .legend {
            padding: 20px 30px;
            background: #f8f9fa;
            border-top: 1px solid #e0e0e0;
        }

        .legend h3 {
            font-size: 1.2em;
            margin-bottom: 15px;
            color: #2c3e50;
        }

        .legend-items {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            padding: 10px;
            background: white;
            border-radius: 5px;
            border-left: 4px solid;
        }

        .legend-item.action { border-left-color: #f1c40f; }
        .legend-item.flood { border-left-color: #e67e22; }
        .legend-item.moderate { border-left-color: #e74c3c; }
        .legend-item.major { border-left-color: #c0392b; }
        .legend-item.near-record { border-left-color: #8e44ad; }

        .legend-item strong {
            margin-right: 10px;
            min-width: 140px;
        }

        footer {
            padding: 20px 30px;
            text-align: center;
            color: #666;
            font-size: 0.9em;
            border-top: 1px solid #e0e0e0;
        }

        .loading {
            text-align: center;
            padding: 50px;
            font-size: 1.2em;
            color: #666;
        }

        .error {
            text-align: center;
            padding: 50px;
            color: #e74c3c;
            font-size: 1.2em;
        }

        .mobile-version {
            display: none;
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            header h1 {
                font-size: 1.5em;
            }

            header p {
                font-size: 0.9em;
            }

            header {
                padding: 20px 15px;
            }

            .status-bar {
                padding: 15px;
                gap: 10px;
            }

            .status-card {
                padding: 15px 10px;
            }

            .status-card h3 {
                font-size: 0.7em;
            }

            .status-card .value {
                font-size: 2.5em;
            }

            .chart-container {
                padding: 10px;
                overflow-x: hidden;
            }

            .chart-wrapper {
                overflow: hidden;
                max-width: 100%;
            }

            #riverChart {
                height: 400px;
            }

            .legend {
                padding: 15px;
            }

            .legend h3 {
                font-size: 1em;
            }

            .legend-items {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .legend-item {
                padding: 8px;
                font-size: 0.9em;
            }

            .legend-item strong {
                min-width: auto;
            }

            footer {
                padding: 15px;
                font-size: 0.8em;
            }

            footer p {
                margin-top: 8px !important;
            }

            .desktop-version {
                display: none;
            }

            .mobile-version {
                display: inline !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üåä Wabash River at Hutsonville Bridge</h1>
            <p>Real-time River Stage Monitoring</p>
        </header>

        <div class="status-bar">
            <div class="status-card" id="currentStageCard">
                <h3>Current Stage (ft)</h3>
                <div class="value" id="currentStage">--</div>
            </div>
        </div>

        <div class="chart-container">
            <div class="chart-wrapper">
                <div id="riverChart" class="loading">Loading data...</div>
            </div>
        </div>

        <div class="legend">
            <h3>Flood Stage Reference</h3>
            <div class="legend-items">
                <div class="legend-item action">
                    <strong>Action Stage:</strong> 12 ft
                </div>
                <div class="legend-item flood">
                    <strong>Flood Stage:</strong> 16 ft
                </div>
                <div class="legend-item moderate">
                    <strong>Moderate Flooding:</strong> 24 ft
                </div>
                <div class="legend-item major">
                    <strong>Major Flooding:</strong> 28 ft
                </div>
                <div class="legend-item near-record">
                    <strong>Near Record:</strong> 29 ft
                </div>
            </div>
        </div>

        <footer>
            <p><strong>Status:</strong> <span id="status">--</span> | <strong>Last Updated:</strong> <span id="lastUpdate">--</span></p>
            <p style="margin-top: 10px; font-size: 0.85em;">Data updates every 15 minutes | Flood stages are approximate reference values. For official information, consult the National Weather Service.</p>
            <p style="margin-top: 15px; font-size: 0.9em;">
                <strong>Related Gauges:</strong>
                <a href="https://water.noaa.gov/gauges/TERI3" target="_blank" rel="noopener noreferrer" style="color: #3498db; text-decoration: none; margin: 0 10px;">Upstream (TERI3)</a> |
                <a href="https://water.noaa.gov/gauges/RVTI3" target="_blank" rel="noopener noreferrer" style="color: #3498db; text-decoration: none; margin: 0 10px;">Downstream (RVTI3)</a>
            </p>
            <p style="margin-top: 10px; font-size: 0.75em; color: #999;">
                <span class="desktop-version">Desktop v5.1-final</span>
                <span class="mobile-version" style="display: none;">Mobile v4.1-final</span>
            </p>
        </footer>
    </div>

    <script>
        // Configuration
        const DATA_URL = 'data/river_data.json';
        const DEFAULT_DAYS = 7;

        // Global data store
        let riverData = null;

        // Fetch and display data
        async function loadData() {
            try {
                const response = await fetch(DATA_URL);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                riverData = await response.json();
                displayData();
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('riverChart').innerHTML = 
                    '<div class="error">Error loading data. Please try again later.</div>';
            }
        }

        function displayData() {
            if (!riverData || !riverData.readings || riverData.readings.length === 0) {
                document.getElementById('riverChart').innerHTML = 
                    '<div class="error">No data available yet.</div>';
                return;
            }

            updateCurrentStatus();
            createChart();
        }

        function updateCurrentStatus() {
            const latest = riverData.readings[riverData.readings.length - 1];
            const currentStage = latest.riverstage;

            document.getElementById('currentStage').textContent = currentStage.toFixed(2);

            const updateTime = new Date(latest.timestamp);
            document.getElementById('lastUpdate').textContent =
                updateTime.toLocaleString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    hour: 'numeric',
                    minute: '2-digit'
                });

            const card = document.getElementById('currentStageCard');
            const statusElement = document.getElementById('status');
            
            card.classList.remove('warning', 'danger');
            
            if (currentStage >= riverData.flood_stages.near_record) {
                statusElement.textContent = '‚ö†Ô∏è Near Record';
                card.classList.add('danger');
            } else if (currentStage >= riverData.flood_stages.major) {
                statusElement.textContent = 'üö® Major';
                card.classList.add('danger');
            } else if (currentStage >= riverData.flood_stages.moderate) {
                statusElement.textContent = '‚ö†Ô∏è Moderate';
                card.classList.add('danger');
            } else if (currentStage >= riverData.flood_stages.flood) {
                statusElement.textContent = '‚ö†Ô∏è Flooding';
                card.classList.add('warning');
            } else if (currentStage >= riverData.flood_stages.action) {
                statusElement.textContent = '‚ö†Ô∏è Action';
                card.classList.add('warning');
            } else {
                statusElement.textContent = '‚úì Normal';
            }
        }

        function createChart() {
            // Clear the loading message
            document.getElementById('riverChart').innerHTML = '';

            const timestamps = riverData.readings.map(r => new Date(r.timestamp));
            const stages = riverData.readings.map(r => r.riverstage);

            const now = new Date();
            const defaultStart = new Date(now.getTime() - (DEFAULT_DAYS * 24 * 60 * 60 * 1000));

            // Calculate Y-axis range based on ALL data (for range slider)
            const maxStageInData = Math.max(...stages);

            // Set Y-axis: lower bound always 0, upper bound scales to highest value with padding
            const yMin = 0;
            const yMax = maxStageInData * 1.1;

            // Check if mobile
            const isMobile = window.innerWidth <= 768;

            // Get the wrapper width to constrain the chart
            const chartWrapper = document.querySelector('.chart-wrapper');
            const chartContainer = document.querySelector('.chart-container');

            // Log dimensions for debugging
            console.log('=== VIEWPORT & CONTAINER ===');
            console.log('Window inner width:', window.innerWidth);
            console.log('Document body scrollWidth:', document.body.scrollWidth);
            console.log('Document body offsetWidth:', document.body.offsetWidth);
            console.log('Container width:', document.querySelector('.container').offsetWidth);
            console.log('Container scrollWidth:', document.querySelector('.container').scrollWidth);
            console.log('=== CHART DIMENSIONS ===');
            console.log('Chart container width:', chartContainer.offsetWidth);
            console.log('Chart wrapper width:', chartWrapper.offsetWidth);

            // Calculate width properly - wrapper width minus large buffer
            // Need significant buffer to prevent container expansion
            const wrapperWidth = chartWrapper.offsetWidth - 200;
            console.log('Width passed to Plotly:', wrapperWidth);

            const trace = {
                x: timestamps,
                y: stages,
                type: 'scatter',
                mode: 'lines+markers',
                name: 'River Stage',
                line: {
                    color: '#3498db',
                    width: 2
                },
                marker: {
                    size: 4,
                    color: '#2980b9'
                },
                hovertemplate: '<b>%{x|%Y-%m-%d %H:%M}</b><br>' +
                               'Stage: %{y:.2f} ft<br>' +
                               '<extra></extra>'
            };

            const shapes = [
                {
                    type: 'line',
                    x0: timestamps[0],
                    x1: timestamps[timestamps.length - 1],
                    y0: riverData.flood_stages.action,
                    y1: riverData.flood_stages.action,
                    line: { color: '#f1c40f', width: 2, dash: 'dash' }
                },
                {
                    type: 'line',
                    x0: timestamps[0],
                    x1: timestamps[timestamps.length - 1],
                    y0: riverData.flood_stages.flood,
                    y1: riverData.flood_stages.flood,
                    line: { color: '#e67e22', width: 2, dash: 'dash' }
                },
                {
                    type: 'line',
                    x0: timestamps[0],
                    x1: timestamps[timestamps.length - 1],
                    y0: riverData.flood_stages.moderate,
                    y1: riverData.flood_stages.moderate,
                    line: { color: '#e74c3c', width: 2, dash: 'dash' }
                },
                {
                    type: 'line',
                    x0: timestamps[0],
                    x1: timestamps[timestamps.length - 1],
                    y0: riverData.flood_stages.major,
                    y1: riverData.flood_stages.major,
                    line: { color: '#c0392b', width: 2, dash: 'dash' }
                },
                {
                    type: 'line',
                    x0: timestamps[0],
                    x1: timestamps[timestamps.length - 1],
                    y0: riverData.flood_stages.near_record,
                    y1: riverData.flood_stages.near_record,
                    line: { color: '#8e44ad', width: 2, dash: 'dash' }
                }
            ];

            const layout = {
                width: wrapperWidth,
                autosize: false,
                title: {
                    text: 'Wabash River Stage',
                    font: { size: isMobile ? 14 : 20 }
                },
                xaxis: {
                    title: isMobile ? '' : 'Date/Time',
                    type: 'date',
                    range: [defaultStart, now],
                    rangeslider: { visible: true },
                    rangeselector: {
                        visible: !isMobile,
                        buttons: [
                            { count: 1, label: '24h', step: 'day', stepmode: 'backward' },
                            { count: 3, label: '3d', step: 'day', stepmode: 'backward' },
                            { count: 7, label: '7d', step: 'day', stepmode: 'backward' },
                            { count: 1, label: '1m', step: 'month', stepmode: 'backward' },
                            { step: 'all', label: 'All' }
                        ],
                        font: { size: 12 },
                        x: 0,
                        y: 1.15
                    }
                },
                yaxis: {
                    title: isMobile ? 'Stage (ft)' : 'River Stage (feet)',
                    zeroline: false,
                    range: [yMin, yMax],
                    autorange: false
                },
                shapes: shapes,
                hovermode: 'closest',
                showlegend: !isMobile,
                legend: {
                    x: 0,
                    y: 1,
                    bgcolor: 'rgba(255, 255, 255, 0.8)'
                },
                margin: isMobile
                    ? { l: 40, r: 10, t: 40, b: 80 }
                    : { l: 60, r: 20, t: 60, b: 80 }
            };

            const config = {
                responsive: false,
                displayModeBar: !isMobile,
                displaylogo: false,
                modeBarButtonsToRemove: ['lasso2d', 'select2d']
            };

            Plotly.newPlot('riverChart', [trace], layout, config);

            // Log actual rendered chart width after Plotly creates it
            setTimeout(function() {
                console.log('=== AFTER PLOTLY RENDER ===');
                const plotlyDiv = document.getElementById('riverChart');
                const svgElement = plotlyDiv.querySelector('.main-svg');
                if (svgElement) {
                    console.log('Actual Plotly SVG width:', svgElement.getAttribute('width'));
                }
                console.log('RiverChart div offsetWidth:', plotlyDiv.offsetWidth);
                console.log('RiverChart div scrollWidth:', plotlyDiv.scrollWidth);
                console.log('Body scrollWidth after render:', document.body.scrollWidth);
                console.log('Container scrollWidth after render:', document.querySelector('.container').scrollWidth);

                // Check if there's horizontal scroll
                const hasHorizontalScroll = document.body.scrollWidth > window.innerWidth;
                console.log('Has horizontal scroll?', hasHorizontalScroll);
                if (hasHorizontalScroll) {
                    console.log('‚ö†Ô∏è OVERFLOW BY:', document.body.scrollWidth - window.innerWidth, 'px');
                }

                // Check container position and visibility
                const container = document.querySelector('.container');
                const containerRect = container.getBoundingClientRect();
                console.log('=== CONTAINER VISIBILITY ===');
                console.log('Container left edge:', containerRect.left, 'px');
                console.log('Container right edge:', containerRect.right, 'px');
                console.log('Viewport width:', window.innerWidth, 'px');
                console.log('Left visible?', containerRect.left >= 0);
                console.log('Right visible?', containerRect.right <= window.innerWidth);

                if (containerRect.left < 0) {
                    console.log('‚ö†Ô∏è LEFT SIDE CUT OFF BY:', Math.abs(containerRect.left), 'px');
                }
                if (containerRect.right > window.innerWidth) {
                    console.log('‚ö†Ô∏è RIGHT SIDE CUT OFF BY:', containerRect.right - window.innerWidth, 'px');
                }
            }, 100);

            // Handle window resize - recalculate width
            let resizeTimeout;
            window.addEventListener('resize', function() {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(function() {
                    // Subtract 200px buffer
                    const newWrapperWidth = chartWrapper.offsetWidth - 200;
                    const newIsMobile = window.innerWidth <= 768;

                    Plotly.relayout('riverChart', {
                        width: newWrapperWidth,
                        'title.font.size': newIsMobile ? 14 : 20,
                        'xaxis.title': newIsMobile ? '' : 'Date/Time',
                        'xaxis.rangeselector.visible': !newIsMobile,
                        'yaxis.title': newIsMobile ? 'Stage (ft)' : 'River Stage (feet)',
                        showlegend: !newIsMobile,
                        margin: newIsMobile
                            ? { l: 40, r: 10, t: 40, b: 80 }
                            : { l: 60, r: 20, t: 60, b: 80 }
                    });
                }, 250);
            });
        }

        function autoRefresh() {
            loadData();
            setTimeout(autoRefresh, 15 * 60 * 1000);
        }

        loadData();
        setTimeout(autoRefresh, 15 * 60 * 1000);
    </script>
</body>
</html>
